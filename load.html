<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chargeur du T24</title>
    <link rel="shortcut icon" href="web/logo.svg" type="image/x-icon">

    <link rel="stylesheet" href="web/style.css">
    <style>
    </style>
</head>
<body>
    <div id="menu">
        <h1>Téléchargement des quiz</h1>
        <p><a href="./">
            Retour à la page d'accueil<br>
            Return to home page<br>
            Trở về trang chủ
        </a></p>
    </div>
</body>

<!-- Load parser to get the subject list -->
<script src="web/parser.js"></script>

<script>
localStorage.clear();

// check if all quizes has been loaded
function loader(s, g, id) {
    SUBJECTS[s][g] = true;
    document.body.innerHTML +=
        'Téléchargé ' + id
        + ' quiz de ' + s + g + '<br>';

    for (const subject of Object.keys(SUBJECTS))
        for (const grade of Object.keys(SUBJECTS[subject]))
            if (!SUBJECTS[subject][grade])
                return false;

    document.body.innerHTML += `Démarrage de l'application...`;
    localStorage.setItem(
        'timestamp',
        new Date().valueOf()
    )
    window.location.href = './' + window.location.hash;
}

let repo = [];
(async () => {
    // if not on Github, use brute-force loading
    if (!window.location.href.includes('github.io')) return;

    // get Github list of quizzes
    repo = await fetch('https://api.github.com/repos/LukeNK/T24/git/trees/main?recursive=1');
    repo = await repo.json();
    localStorage.setItem('version', repo.sha);
    repo = repo.tree.filter(v => v.path.search(/data\/.*\.html/) == 0);
    for (let i in repo)
        repo[i] = repo[i].path; // save paths
})().finally(() => {
    // iterate through data folder to download files
    for (const subject of Object.keys(SUBJECTS)) {
        SUBJECTS[subject] = {};
        for (let grade = 10; grade <= 12; grade++) {
            SUBJECTS[subject][grade] = false;
            (async () => {
                for (let id = 0; id < 100; id++) {
                    let quizPath = `data/${subject}${grade}/${id}.html`;
                    // if the repo list is loaded AND no more quiz is found
                    if ( repo.length != 0 && !repo.includes(quizPath) ) {
                        loader(subject, grade, id);
                        break;
                    };

                    let response = await fetch(quizPath);
                    if (!response.ok) {
                        loader(subject, grade, id);
                        break;
                    }
                    localStorage.setItem(
                        `${subject}${grade}-${id}`,
                        await response.text()
                    );
                }
            })();
        }
    }
});
</script>
</html>
